#!/bin/bash

# Script to install LPR VPN on CerboGX devices
#
# 20230428 JK: Version 1.00

#### following lines incorporate SetupHelper utilities into this script
# Refer to the SetupHelper ReadMe file for details.

source "/data/SetupHelper/CommonResources"

# GitHub account info - fill in as appropriate
# to include this package in SetupHelper automatic updates
packageGitHubUser="tslewis"
packageGitHubBranch="latest"

#### end of lines to include SetupHelper

#### running manually and OK to proceed - prompt for input
if [ $scriptAction == 'NONE' ] ; then
    # display innitial message
    echo
    echo "Install LPR VPN s/w and up on TEMP IP"

    # prompt for standard actions (install, reinstall, uninstall, etc)
    # next step is to install
    scriptAction='INSTALL'
fi

#### install code goes here
if [ $scriptAction == 'INSTALL' ] ; then

    # GitHub based script to pull tarball down to Victron trailer
    NUGGET=peewee
    TRAILER=$(hostname)
    SERVER=nagios.lightnin.net
    SOURCEDIR=/home/tech/distro
    TARGETHOME=/home/root
    FILE=deploy_vpn_cerboGX.tgz

    cd $TARGETHOME

    /usr/bin/wget https://${SERVER}/${NUGGET}/${FILE}
    if [ $? -ne 0 ]
    then
        echo "ERROR: Could not transfer file, please investigate."; exit 1
    fi

    /bin/tar zxvf $TARGETHOME/$FILE -C /
    if [ $? -ne 0 ]
    then
        echo "ERROR: Could not extract file, please investigate.";  exit 2
    fi

    /home/root/start_net.sh
    if [ $? -ne 0 ]
    then
        echo "ERROR: Could not start network, please investigate."; exit 3
    fi

    echo "Completed install of VPN on $TRAILER, network should be up on VTemp"

    # set exit flags as needed
    rebootNeeded=false
fi

# #### uninstalling - check scriptAction again
# if an install step failed package needs to be removed

if [ $scriptAction == 'UNINSTALL' ] ; then
    #### code to uninstall and deactivate package goes here

    RCS=/data/rcS.local
    echo "Killing tinc process (if exists)"
    PID=$(ps | grep tinc |grep -v grep | wc -l)
    if [ $PID -gt 0 ]
    then
        kill $(ps | grep tinc |grep -v grep | awk '{ print $1}')
    fi

    echo Removing files
    rm -rf /usr/local/etc/tinc 
    rm /usr/local/sbin/tincd 
    rm /home/root/start_net.sh 
    rm /home/root/$FILE

    echo Removing startup command
    cp -p $RCS $RCS.temp
    grep -v "start_net" $RCS.temp > $RCS
    rm $RCS.temp

    # set exit flags as needed
    rebootNeeded=false
fi

# thats all folks - SCRIPT EXITS INSIDE THE FUNCTION
endScript
