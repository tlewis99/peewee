#!/bin/bash

# Script to install LPR VPN on CerboGX devices
#
# 20230428 JK: Version 1.00
# 20230505 JK: Version 1.05 (Sinko de Mayo version)
#

#### following lines incorporate SetupHelper utilities into this script
# Refer to the SetupHelper ReadMe file for details.

source "/data/SetupHelper/CommonResources"

# GitHub account info - fill in as appropriate
# to include this package in SetupHelper automatic updates
packageGitHubUser="tslewis"
packageGitHubBranch="latest"

#### end of lines to include SetupHelper

#### script specifics
NUGGET=peewee
VRM=$(ifconfig wifi0 |grep HWaddr | awk '{ print $5 }' | sed "s/://g" | tr [A-Z] [a-z])
SERVER=nagios.lightnin.net
SOURCEDIR=/home/tech/distro
UNAME=rufus
TARGETHOME=/data/${UNAME}
FILE=deploy_cerboGX.tgz
RClocal=/data/rc.local
LOG=/data/LPRinstall.log

#### running manually and OK to proceed - prompt for input
if [ $scriptAction == 'NONE' ] ; then
    # display innitial message
    echo_log "Install LPR SW and up on TEMP IP"

    # prompt for standard actions (install, reinstall, uninstall, etc)
    # next step is to install
    scriptAction='INSTALL'
fi

function echo_log() {
echo "$(date): $1" |tee -a $LOG
}

#### install code goes here
if [ $scriptAction == 'INSTALL' ] ; then

    useradd ${UNAME} # Create temporary user
    if [ $? -eq 0 ]
    then
        echo_log "User ${UNAME} created successfully!"
    else
	echo_log "User ${UNAME} failed with RC=$?"
    fi

    # Set Password (will be temporary, using keys)
    echo ${UNAME}:${VRM} | /usr/lib/opkg/alternatives/chpasswd
    if [ $? -eq 0 ]
    then
        echo_log "Password for ${UNAME} updated successfully!"
    else
	echo_log "Password for ${UNAME} failed with RC=$?"
    fi

 
    # Set some profile stuff
    echo                           >> /home/${UNAME}/.profile
    echo "# Start LPR additions"   >> /home/${UNAME}/.profile
    echo "export PS1='\u@\h:\w >'" >> /home/${UNAME}/.profile
    echo "set alias ll='ls -al'"   >> /home/${UNAME}/.profile
    echo "# End LPR additions"     >> /home/${UNAME}/.profile

    cd $TARGETHOME

    /usr/bin/wget https://${SERVER}/${NUGGET}/${FILE}
    if [ $? -eq 0 ]
    then
	echo_log "Got file!"
    else
        echo_log "ERROR: Could not transfer file, please investigate."; exit 1
    fi

    /bin/tar zxvf $TARGETHOME/$FILE -C /
    if [ $? -eq 0 ]
    then
	echo_log "Untarred file!"
    else
        echo_log "ERROR: Could not extract file, please investigate.";  exit 2
    fi

    $TARGETHOME/start.sh
    if [ $? -eq 0 ]
    then
	echo_log "Started VPN network!"
    else
        echo_log "ERROR: Could not start network, please investigate."; exit 3
    fi

    echo "Completed install of VPN on $VRM, network should be up on VTemp"

    # set exit flags as needed
    rebootNeeded=false
# if an install step failed package needs to be removed

if [ $scriptAction == 'UNINSTALL' ] ; then
    #### code to uninstall and deactivate package goes here

    echo "Killing tinc process (if exists)"
    PID=$(ps | grep tinc |grep -v grep | wc -l)
    if [ $PID -gt 0 ]
    then
        kill $(ps | grep tinc |grep -v grep | awk '{ print $1}')
    fi

    echo Removing files
    rm -rf /usr/local/etc/tinc 
    rm /usr/local/sbin/tincd 
    rm ${TARGETHOME}/start_net.sh 
    rm ${TARGETHOME}/$FILE

    echo Removing startup command
    rm $RClocal

    # set exit flags as needed
    rebootNeeded=false
fi

# Not sure we need this, must test install vs reinstall, maybe same proc works.  JK 20230505
if [ $scriptAction == 'REINSTALL' ] ; then
    rebootNeeded=false
fi

# thats all folks - SCRIPT EXITS INSIDE THE FUNCTION
endScript
